<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>1933, ì²´ì œë¥¼ ëŒëŸ¬ë³´ë‹¤</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    @font-face {
        font-family: 'Danjo-bold-Regular';
        src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2307-1@1.1/Danjo-bold-Regular.woff2') format('woff2');
        font-weight: normal;
        font-style: normal;
    }

    /* Danjo-bold-Regular ê¸€ë¡œë²Œ ì ìš© */
    body {
      font-family: 'Danjo-bold-Regular', sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    /* ë°°ê²½ ì´ë¯¸ì§€ë§Œì„ ìœ„í•œ ë³„ë„ì˜ div */
    .background-image-blur {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        /* 1933 ë…ì¼ ì„ ê±° ì§€ë„ ì´ë¯¸ì§€ë¡œ ë³€ê²½ */
        background-image: url('https://upload.wikimedia.org/wikipedia/commons/e/eb/Wahl_zum_Reichstag_1932-11.png'); /* 1933ë…„ ì„ ê±° ì§€ë„ëŠ” 1932ë…„ 11ì›” ì„ ê±°ì™€ ë™ì¼í•œ ì´ë¯¸ì§€ ì‚¬ìš© */
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center center;
        background-attachment: fixed;
        filter: blur(15px); /* íë¦¼ íš¨ê³¼ 15px (ëŒ€ëµ 30% íë¦¼) */
        -webkit-filter: blur(15px);
        z-index: -1;
    }

    /* ëª¨ë“  UI ì½˜í…ì¸ ë¥¼ ë‹´ì„ ë˜í¼ */
    .content-wrapper {
        position: relative;
        z-index: 1;
        padding: 30px;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        box-sizing: border-box;
    }

    h2, h3 {
      text-align: center;
      margin-bottom: 20px;
      width: 100%;
      max-width: 900px;
    }

    .party-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
      width: 100%;
      max-width: 900px;
      box-sizing: border-box;
      padding: 0 15px;
    }

    .party-card {
      width: 130px;
      height: 130px;
      border-radius: 12px;
      background: #333; /* ê¸°ë³¸ ë°°ê²½ìƒ‰ (ë®ì–´ì”Œì›Œì§ˆ ì˜ˆì •) */
      color: #fff; /* ê¸°ë³¸ ê¸€ììƒ‰ */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    /* ì…ë ¥ë€ ìŠ¤íƒ€ì¼ ìˆ˜ì •: ë°°ê²½ìƒ‰ê³¼ ê¸€ììƒ‰ ë° í°íŠ¸ ì ìš© */
    .party-card input {
      font-family: 'Danjo-bold-Regular', sans-serif;
      width: 60px;
      text-align: center;
      font-size: 18px;
      margin: 6px 0;
      border-radius: 4px;
      border: none;
      padding: 4px;
      color: rgba(255, 255, 255, 0.75); /* ê¸€ììƒ‰ í°ìƒ‰ì— íˆ¬ëª…ë„ 75% */
      transition: color 0.2s ease-in-out;
    }

    /* ì…ë ¥ë€ì— í¬ì»¤ìŠ¤ë  ë•Œ ê¸€ì íˆ¬ëª…ë„ ì œê±° */
    .party-card input:focus {
        color: white; /* í¬ì»¤ìŠ¤ ì‹œ ê¸€ììƒ‰ í°ìƒ‰ (íˆ¬ëª…ë„ ì—†ìŒ) */
        outline: none;
    }

    .calculate-button {
      font-family: 'Danjo-bold-Regular', sans-serif;
      display: block;
      margin: 0 auto 30px;
      padding: 14px 40px;
      font-size: 16px;
      font-weight: bold;
      background: #004c47;
      color: white;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      width: 100%;
      max-width: 900px;
      box-sizing: border-box;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-bottom: 30px;
      font-size: 14px;
      margin-left: auto;
      margin-right: auto;
      max-width: 900px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: center;
    }

    th {
      background: #eee;
    }

    .winner {
      font-weight: bold;
      background: #d0ffd0;
    }

    .dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
      vertical-align: middle;
    }

    /* New styles for Seat Projection */
    .seat-projection-container {
      width: 100%;
      max-width: 900px;
      background-color: #e0e0e0;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      margin-top: 30px;
      margin-bottom: 30px;
      box-sizing: border-box;
    }

    .seat-projection-title {
        font-size: 1.8em;
        font-weight: bold;
        text-align: center;
        margin-bottom: 20px;
        color: #333;
    }

    .seat-projection-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }

    .projection-party-card {
      width: 140px;
      height: 120px;
      border-radius: 12px;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      text-align: center;
      padding: 10px;
      box-sizing: border-box;
    }

    .projection-party-name {
      font-size: 1.1em;
      margin-bottom: 5px;
      text-transform: uppercase;
    }

    .projection-seats {
      font-size: 2.5em;
      line-height: 1;
      margin-bottom: 5px;
    }

    .projection-percentage {
        font-size: 0.9em;
        color: rgba(255, 255, 255, 0.9);
        margin-top: -3px;
    }

    .projection-change {
        font-size: 0.9em;
        color: rgba(255, 255, 255, 0.8);
    }

    /* ë§‰ëŒ€ ê·¸ë˜í”„ ìŠ¤íƒ€ì¼ */
    .seat-bar-container {
        width: 100%;
        height: 25px;
        background-color: #ccc;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 25px;
        display: flex;
    }

    .seat-bar-segment {
        height: 100%;
    }

    /* Individual Constituency Results ì„¹ì…˜ */
    .constituency-results {
        width: 100%;
        max-width: 900px;
        background-color: #e0e0e0;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        margin-top: 30px;
        box-sizing: border-box;
        text-align: center;
    }

    .constituency-results h3 {
        margin-top: 0;
    }

    .constituency-select-container {
        margin-top: 20px;
        margin-bottom: 20px;
        width: 100%;
        display: flex;
        justify-content: center;
    }

    /* ë“œë¡­ë‹¤ìš´ì—ë„ Danjo í°íŠ¸ ì ìš© */
    .constituency-select-container select {
        font-family: 'Danjo-bold-Regular', sans-serif;
        width: 80%;
        max-width: 400px;
        padding: 8px 12px;
        font-size: 1em;
        border: 1px solid #ccc;
        border-radius: 5px;
        appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.2-6.5H18.6c-5%200-9.3%201.8-12.9%205.5-3.8%203.7-5.7%208-5.7%2012.9v120.9c0%204.9%201.9%209.2%205.7%2012.9%203.6%203.7%207.9%205.5%2012.9%205.5h255.2c5%200%209.3-1.8%2012.9-5.5%203.8-3.7%205.7-8%205.7-12.9z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 12px;
        cursor: pointer;
    }

    .constituency-detail {
        margin-top: 15px;
        font-size: 0.95em;
        color: #555;
    }
    .constituency-detail ul {
        list-style: none;
        padding: 0;
        margin: 10px 0;
        text-align: left;
    }
    .constituency-detail ul li {
        margin-bottom: 5px;
        padding: 3px 0;
    }
    .constituency-detail ul li .dot {
        vertical-align: middle;
    }

    /* ëª¨ë°”ì¼ìš© ë¯¸ë””ì–´ ì¿¼ë¦¬ */
    @media (max-width: 768px) {
        .content-wrapper {
            padding: 15px;
        }
        .party-card {
            width: 100px;
            height: 100px;
            font-size: 0.9em;
        }
        .party-card input {
            width: 50px;
            font-size: 16px;
        }
        .calculate-button {
            padding: 10px 20px;
            font-size: 14px;
        }
        .projection-party-card {
            width: 120px;
            height: 100px;
        }
        .projection-seats {
            font-size: 2em;
        }
        table {
            font-size: 12px;
        }
        th, td {
            padding: 4px 6px;
        }
    }
  </style>
</head>

<body>
  <div class="background-image-blur"></div>

  <div class="content-wrapper">
    <h2>ğŸ—³ï¸ 1933, ì²´ì œë¥¼ ëŒëŸ¬ë³´ë‹¤</h2>

    <div class="party-grid" id="partyGrid"></div>
    <button class="calculate-button" onclick="runPrediction()">ì˜ì„ ë° ê²°ê³¼ ê³„ì‚°</button>

    <div class="seat-projection-container">
      <div class="seat-projection-title">ì˜ˆì¸¡ ì˜ì„</div>
      <div class="seat-projection-grid" id="seatProjectionGrid"></div>
      <div class="seat-bar-container" id="seatBarContainer"></div>
    </div>

    <h3>ğŸ“ ì§€ì—­ë³„ ì˜ˆì¸¡</h3>
    <div id="districtResults"></div>

    <div class="constituency-results">
      <h3>ê°œë³„ ì„ ê±°êµ¬ ê²°ê³¼</h3>
      <div class="constituency-select-container">
        <select onchange="showConstituencyDetail(this.value)">
          <option value="">ì„ ê±°êµ¬ë¥¼ ê²€ìƒ‰í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”...</option>
          </select>
      </div>
      <div class="constituency-detail" id="constituencyDetail">
        ìì„¸í•œ ë¶„ì„ì„ ë³´ë ¤ë©´ ì„ ê±°êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.
      </div>
    </div>
  </div>
  <script>
    const TOTAL_SEATS = 647; // 1933ë…„ 3ì›” ì´ì„  ê¸°ì¤€ ì´ ì˜ì„ìˆ˜
    const ELECTORAL_THRESHOLD = 0; // ë°”ì´ë§ˆë¥´ ê³µí™”êµ­ ì´ì„ ì€ ì „êµ­ ë‹¨ìœ„ ë´‰ì‡„ ì¡°í•­ ì—†ìŒ

    const parties = [
      // ì´ë¯¸ì§€ 104218.jpg ìš°ì¸¡ ì°¨íŠ¸ ë°ì´í„° ê¸°ë°˜, ì¤„ì„ë§ ì ìš©
      { id: "nsdap", name: "NSDAP", color: "#6c3913", vote: 43.91, regionOnly: null }, // Nazi Party
      { id: "spd", name: "SPD", color: "#FF0000", vote: 18.25, regionOnly: null }, // Social Democratic Party
      { id: "kpd", name: "KPD", color: "#a87cd4", vote: 12.32, regionOnly: null }, // Communist Party
      { id: "zentrum", name: "Zentrum", color: "#000000", vote: 11.25, regionOnly: null }, // Catholic Centre Party
      { id: "dnvp", name: "DNVP", color: "#1e73be", vote: 8.34, regionOnly: null }, // German National People's Party
      { id: "bvp", name: "BVP", color: "#0dafc8", vote: 2.73, regionOnly: "bavaria" }, // Bavarian People's Party (ë°”ì´ì—ë¥¸ ì§€ì—­êµ¬ íŠ¹í™”)
      { id: "dvp", name: "DVP", color: "#FFBF00", vote: 1.10, regionOnly: null }, // German People's Party
      { id: "csdv", name: "CSDV", color: "#00BFFF", vote: 0.98, regionOnly: null }, // Christian-Social People's Service
      { id: "dstp", name: "DStP", color: "#ADD8E6", vote: 0.85, regionOnly: null }, // German State Party
      { id: "wp", name: "WP", color: "#32CD32", vote: 0.29, regionOnly: null }, // German Peasants' Party (Wirtschaftspartei / Economic Party of the Middle Class)
      { id: "rlb", name: "RLB", color: "#A0522D", vote: 0.21, regionOnly: null } // Reich Agricultural League
    ];

// 1933ë…„ 3ì›” ë…ì¼ ì´ì„  ì„ ê±°êµ¬ ë°ì´í„° (ì´ë¯¸ì§€ 104218.jpg ì§€ë„ ê¸°ë°˜)
const districts = [
  { id: 1, name: "ë™í”„ë¡œì´ì„¼", seats: 18 }, /* 1. East Prussia */
  { id: 2, name: "ë² ë¥¼ë¦°", seats: 19 }, /* 2. Berlin */
  { id: 3, name: "í¬ì¸ ë‹´ I", seats: 19 }, /* 3. Potsdam I */
  { id: 4, name: "í¬ì¸ ë‹´ II", seats: 16 }, /* 4. Potsdam II */
  { id: 5, name: "í”„ë‘í¬í‘¸ë¥´íŠ¸ ì•ˆ ë°ì–´ ì˜¤ë”", seats: 13 }, /* 5. Frankfurt an der Oder */
  { id: 6, name: "í¬ë©”ë¼ë‹ˆì•„", seats: 17 }, /* 6. Pomerania */
  { id: 7, name: "ë©”í´ë Œë¶€ë¥´í¬", seats: 7 }, /* 7. Mecklenburg */
  { id: 8, name: "ìŠë ˆìŠ¤ë¹„íˆ-í™€ìŠˆíƒ€ì¸", seats: 15 }, /* 8. Schleswig-Holstein */
  { id: 9, name: "í•¨ë¶€ë¥´í¬", seats: 11 }, /* 9. Hamburg */
  { id: 10, name: "ë² ì €-ì— ìŠ¤", seats: 14 }, /* 10. Weser-Ems */
  { id: 11, name: "ë™í•˜ë…¸ë²„", seats: 9 }, /* 11. East Hanover */
  { id: 12, name: "ë‚¨í•˜ë…¸ë²„-ë¸Œë¼ìš´ìŠˆë°”ì´í¬", seats: 19 }, /* 12. South Hanover-Braunschweig */
  { id: 13, name: "ë§ˆê·¸ë°ë¶€ë¥´í¬", seats: 17 }, /* 13. Magdeburg */
  { id: 14, name: "ë©”ë¥´ì œë¶€ë¥´í¬", seats: 13 }, /* 14. Merseburg */
  { id: 15, name: "í—¤ì„¼-ë‚˜ì‚¬ìš°", seats: 23 }, /* 15. Hesse-Nassau */
  { id: 16, name: "íŠ€ë§ê²", seats: 19 }, /* 16. Thuringia */
  { id: 17, name: "ì‘ì„¼", seats: 21 }, /* 17. Saxony */
  { id: 18, name: "ë¼ì´í”„ì¹˜íˆ", seats: 13 }, /* 18. Leipzig */
  { id: 19, name: "ë“œë ˆìŠ¤ë´-ë°”ìš°ì²¸", seats: 19 }, /* 19. Dresden-Bautzen */
  { id: 20, name: "ì¼ë‹ˆì¸ -ì¸ ë¹„ì¹´ìš°", seats: 17 }, /* 20. Chemnitz-Zwickau */
  { id: 21, name: "ìƒë¶€ ë°”ì´ì—ë¥¸ - ìŠˆë°”ë²¤", seats: 19 }, /* 21. Upper Bavaria-Swabia */
  { id: 22, name: "í•˜ë¶€ ë°”ì´ì—ë¥¸ - ìƒë¶€ íŒ”ì¸ ", seats: 9 }, /* 22. Lower Bavaria-Upper Palatinate */
  { id: 23, name: "í”„ë‘ì¼„", seats: 24 }, /* 23. Franconia */
  { id: 24, name: "íŒ”ì¸ ", seats: 8 }, /* 24. Palatinate */
  { id: 25, name: "ë·”ë¥´í…œë² ë¥´í¬", seats: 24 }, /* 25. WÃ¼rttemberg */
  { id: 26, name: "ë°”ë´", seats: 21 }, /* 26. Baden */
  { id: 27, name: "ì¾°ë¥¸-ì•„í—¨", seats: 19 }, /* 27. Cologne-Aachen */
  { id: 28, name: "ì½”ë¸”ë Œì¸ -íŠ¸ë¦¬ì–´", seats: 11 }, /* 28. Koblenz-Trier */
  { id: 29, name: "í—¤ì„¸-ë‹¤ë¦„ìŠˆíƒ€íŠ¸", seats: 13 }, /* 29. Hesse-Darmstadt */
  { id: 30, name: "ë’¤ì…€ë„ë¥´í”„ ë™ë¶€", seats: 21 }, /* 30. DÃ¼sseldorf East */
  { id: 31, name: "ë’¤ì…€ë„ë¥´í”„ ì„œë¶€", seats: 17 }, /* 31. DÃ¼sseldorf West */
  { id: 32, name: "ë² ìŠ¤íŠ¸íŒ”ë Œ ë¶ë¶€", seats: 24 }, /* 32. Westphalia North */
  { id: 33, name: "ë² ìŠ¤íŠ¸íŒ”ë Œ ë‚¨ë¶€", seats: 21 }, /* 33. Westphalia South */
  { id: 34, name: "ë¸Œë ˆìŠ¬ë¼ìš°", seats: 17 }, /* 34. Breslau */
  { id: 35, name: "ì˜¤í ë¥¸", seats: 12 }, /* 35. Oppeln */
  { id: 36, name: "ë¦¬ê·¸ë‹ˆì¸ ", seats: 11 } /* 36. Liegnitz */
];
// ì§€ë„ì— ìˆëŠ” ì˜ì„ìˆ˜ë¥¼ ëª¨ë‘ ë”í•˜ë©´ 647ì´ ë©ë‹ˆë‹¤.

    // êµ¬ì—­ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
    function populateConstituencyDropdown() {
        const select = document.querySelector('.constituency-select-container select');
        districts.forEach(district => {
            const option = document.createElement('option');
            option.value = district.id;
            option.textContent = district.name;
            select.appendChild(option);
        });
    }

    // êµ¬ì—­ ìƒì„¸ ì •ë³´ í‘œì‹œ: ì •ë‹¹ë³„ ë“í‘œìœ¨ì„ í‘œì‹œí•˜ë„ë¡ ìˆ˜ì •
    function showConstituencyDetail(districtId) {
        const detailDiv = document.getElementById('constituencyDetail');
        if (districtId === "") {
            detailDiv.innerHTML = "ìì„¸í•œ ë¶„ì„ì„ ë³´ë ¤ë©´ ì„ ê±°êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.";
            return;
        }

        const selectedDistrict = districts.find(d => d.id == districtId);
        if (!selectedDistrict) {
            detailDiv.innerHTML = "ì„ ê±°êµ¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            return;
        }

        let rawVotes = {}, totalDistrictVotes = 0;

        parties.forEach(p => {
          let shouldInclude = true;
          // 'regionOnly' ë¡œì§: Bavaria (ë°”ì´ì—ë¥¸) ë° Hanover (í•˜ë…¸ë²„) ì§€ì—­ ì •ë‹¹ë§Œ í•´ë‹¹
          if (p.regionOnly) {
            const districtNameLower = selectedDistrict.name.toLowerCase();
            // ë°”ì´ì—ë¥¸ ì§€ì—­ ì •ë‹¹ì€ í•´ë‹¹ ì§€ì—­êµ¬ì—ë§Œ ì ìš©
            if (p.regionOnly === "bavaria" && 
                !(districtNameLower.includes("bavaria") || 
                  districtNameLower.includes("franconia") || 
                  districtNameLower.includes("palatinate") || 
                  districtNameLower.includes("upper bavaria") || 
                  districtNameLower.includes("lower bavaria"))) {
              shouldInclude = false;
            } 
            // í•˜ë…¸ë²„ ì§€ì—­ ì •ë‹¹ì€ í•´ë‹¹ ì§€ì—­êµ¬ì—ë§Œ ì ìš© (ì´ ë°ì´í„°ì—ëŠ” ì—†ì§€ë§Œ í˜¹ì‹œ ëª¨ë¥¼ ëŒ€ë¹„)
            else if (p.regionOnly === "hanover" && !districtNameLower.includes("hanover")) {
              shouldInclude = false;
            }
          }

          if (shouldInclude) {
            const partyObj = parties.find(party => party.id === p.id);
            const noise = (Math.random() * 10 - 5);
            const raw = Math.max(0, partyObj.vote + noise);
            rawVotes[p.id] = raw;
            totalDistrictVotes += raw;
          }
        });

        let normalized = {};
        for (let pid in rawVotes) {
          normalized[pid] = (rawVotes[pid] / totalDistrictVotes) * 100;
        }

        let detailHtml = `<h4>${selectedDistrict.name} (${selectedDistrict.seats} ì˜ì„)</h4>`;
        detailHtml += `<ul>`;

        const sortedDistrictParties = Object.keys(normalized).map(pid => {
            return {
                party: parties.find(p => p.id === pid),
                percentage: normalized[pid]
            };
        }).sort((a, b) => b.percentage - a.percentage);

        sortedDistrictParties.forEach(({ party, percentage }) => {
            detailHtml += `<li><span class="dot" style="background:${party.color}"></span> ${party.name}: ${percentage.toFixed(1)}%</li>`;
        });
        detailHtml += `</ul>`;

        detailDiv.innerHTML = detailHtml;
    }

    function renderPartyCards() {
      const grid = document.getElementById("partyGrid");
      grid.innerHTML = "";
      parties.forEach(p => {
        const card = document.createElement("div");
        card.className = "party-card";
        card.style.backgroundColor = p.color;
        card.innerHTML = `
          <div>${p.name}</div>
          <input type="number" value="${p.vote}" onchange="updateVote('${p.id}', this.value)"
                 style="background-color: ${p.color}; color: rgba(255, 255, 255, 0.75);">
          <small>${p.regionOnly ? p.regionOnly.charAt(0).toUpperCase() + p.regionOnly.slice(1) : 'ì „êµ­'}</small>
        `;
        grid.appendChild(card);
      });
    }

    function updateVote(id, value) {
      const party = parties.find(p => p.id === id);
      party.vote = parseFloat(value) || 0;
    }

    function allocateSeats(partyPercents, seats) {
      let scores = [];
      // ë´‰ì‡„ ì¡°í•­ì´ 0%ì´ë¯€ë¡œ ëª¨ë“  ì •ë‹¹ì´ ì°¸ì—¬
      let totalQualifiedPercent = 0;
      Object.keys(partyPercents).forEach(pid => {
          totalQualifiedPercent += partyPercents[pid];
      });

      Object.keys(partyPercents).forEach(pid => {
          const recalculatedPercent = totalQualifiedPercent > 0 ? (partyPercents[pid] / totalQualifiedPercent) * 100 : 0;
          
          for (let i = 0; i < seats; i++) {
            scores.push({ id: pid, score: recalculatedPercent / (2 * i + 1) });
          }
      });
      
      scores.sort((a, b) => b.score - a.score);
      let result = {};
      scores.slice(0, seats).forEach(s => {
        result[s.id] = (result[s.id] || 0) + 1;
      });
      return result;
    }

    function runPrediction() {
      const districtResults = document.getElementById('districtResults');
      const seatProjectionGrid = document.getElementById('seatProjectionGrid');
      const seatBarContainer = document.getElementById('seatBarContainer');

      let nationalSeats = {};
      let nationalTotalVotes = 0;
      let partyNationalVotes = {};

      districtResults.innerHTML = "";
      seatProjectionGrid.innerHTML = "";
      seatBarContainer.innerHTML = "";

      const table = document.createElement("table");
      const header = `<tr>
        <th>êµ¬ì—­</th>
        ${parties.map(p => `<th>${p.name}</th>`).join("")}
        <th>ìŠ¹ì</th>
      </tr>`;
      table.innerHTML = header;

      // 1. ëª¨ë“  ì§€ì—­êµ¬ì˜ raw votesë¥¼ í•©ì‚°í•˜ì—¬ ì „êµ­ ì´ íˆ¬í‘œìˆ˜ ë° ì •ë‹¹ë³„ ì „êµ­ íˆ¬í‘œìˆ˜ ê³„ì‚°
      districts.forEach(district => {
        let rawVotes = {}, totalDistrictVotes = 0;

        parties.forEach(p => {
          let shouldInclude = true;
          if (p.regionOnly) {
            const districtNameLower = district.name.toLowerCase();
            // ë°”ì´ì—ë¥¸ ì§€ì—­ ì •ë‹¹ì€ í•´ë‹¹ ì§€ì—­êµ¬ì—ë§Œ ì ìš©
            if (p.regionOnly === "bavaria" && 
                !(districtNameLower.includes("bavaria") || 
                  districtNameLower.includes("franconia") || 
                  districtNameLower.includes("palatinate") || 
                  districtNameLower.includes("upper bavaria") || 
                  districtNameLower.includes("lower bavaria"))) {
              shouldInclude = false;
            } 
            // í•˜ë…¸ë²„ ì§€ì—­ ì •ë‹¹ì€ í•´ë‹¹ ì§€ì—­êµ¬ì—ë§Œ ì ìš© (ì´ ë°ì´í„°ì—ëŠ” ì—†ì§€ë§Œ í˜¹ì‹œ ëª¨ë¥¼ ëŒ€ë¹„)
            else if (p.regionOnly === "hanover" && !districtNameLower.includes("hanover")) {
              shouldInclude = false;
            }
          }

          if (shouldInclude) {
            const noise = (Math.random() * 10 - 5);
            const raw = Math.max(0, p.vote + noise);
            rawVotes[p.id] = raw;
            totalDistrictVotes += raw;
          }
        });

        for (let pid in rawVotes) {
            partyNationalVotes[pid] = (partyNationalVotes[pid] || 0) + rawVotes[pid];
        }
        nationalTotalVotes += totalDistrictVotes;
      });

      // 2. ì „êµ­ ë“í‘œìœ¨ ê³„ì‚° (ë´‰ì‡„ ì¡°í•­ì€ 0%ì´ë¯€ë¡œ ëª¨ë“  ì •ë‹¹ì´ 'qualified')
      const qualifiedNationalParties = [];
      const nationalPartyPercentages = {};
      
      parties.forEach(p => {
          const nationalPercent = (partyNationalVotes[p.id] / nationalTotalVotes) * 100;
          nationalPartyPercentages[p.id] = nationalPercent;

          // ë´‰ì‡„ ì¡°í•­ì´ 0%ì´ë¯€ë¡œ ëª¨ë“  ì •ë‹¹ì´ ìë™ìœ¼ë¡œ í¬í•¨
          qualifiedNationalParties.push(p.id);
      });

      // 3. ê° ì§€ì—­êµ¬ë³„ ì˜ì„ í• ë‹¹ (ì „êµ­ ë´‰ì‡„ ì¡°í•­ í†µê³¼í•œ ì •ë‹¹ë§Œ ì°¸ì—¬)
      districts.forEach(district => {
        let rawVotesForDistrict = {}, totalDistrictVotesForAllocation = 0;

        parties.forEach(p => {
            // ëª¨ë“  ì •ë‹¹ì´ ì°¸ì—¬í•˜ë¯€ë¡œ ì¡°ê±´ ê²€ì‚¬ í•„ìš” ì—†ìŒ
            // (ê·¸ëŸ¬ë‚˜ ì§€ì—­ íŠ¹í™” ì •ë‹¹ì€ í•´ë‹¹ ì§€ì—­êµ¬ì—ì„œë§Œ íˆ¬í‘œê°€ ë°˜ì˜ë¨)
            let shouldIncludeInDistrict = true;
            if (p.regionOnly) {
                const districtNameLower = district.name.toLowerCase();
                if (p.regionOnly === "bavaria" && 
                    !(districtNameLower.includes("bavaria") || 
                      districtNameLower.includes("franconia") || 
                      districtNameLower.includes("palatinate") || 
                      districtNameLower.includes("upper bavaria") || 
                      districtNameLower.includes("lower bavaria"))) {
                    shouldIncludeInDistrict = false;
                }
                else if (p.regionOnly === "hanover" && !districtNameLower.includes("hanover")) {
                    shouldIncludeInDistrict = false;
                }
            }

            if (shouldIncludeInDistrict) {
                const partyObj = parties.find(party => party.id === p.id);
                const noise = (Math.random() * 10 - 5);
                const raw = Math.max(0, partyObj.vote + noise);
                rawVotesForDistrict[p.id] = raw;
                totalDistrictVotesForAllocation += raw;
            }
        });


        let normalizedDistrictAllocation = {};
        Object.keys(rawVotesForDistrict).forEach(pid => {
            if (totalDistrictVotesForAllocation > 0) {
                normalizedDistrictAllocation[pid] = (rawVotesForDistrict[pid] / totalDistrictVotesForAllocation) * 100;
            } else {
                normalizedDistrictAllocation[pid] = 0;
            }
        });

        const seatMap = allocateSeats(normalizedDistrictAllocation, district.seats);
        Object.entries(seatMap).forEach(([id, count]) => {
          nationalSeats[id] = (nationalSeats[id] || 0) + count;
        });

        // êµ¬ì—­ë³„ ìŠ¹ì ê²°ì •
        let winnerInDistrict = null;
        let maxPercentInDistrict = -1;
        Object.keys(normalizedDistrictAllocation).forEach(pid => {
            if (normalizedDistrictAllocation[pid] > maxPercentInDistrict) {
                maxPercentInDistrict = normalizedDistrictAllocation[pid];
                winnerInDistrict = parties.find(p => p.id === pid);
            }
        });

        const row = document.createElement("tr");
        row.innerHTML = `<td>${district.name}</td>`;
        parties.forEach(p => {
          const districtPercentage = (rawVotesForDistrict[p.id] !== undefined && totalDistrictVotesForAllocation > 0) ? 
                                     ((rawVotesForDistrict[p.id] / totalDistrictVotesForAllocation) * 100).toFixed(1) + '%' : '-';
          
          const allocatedSeats = (seatMap[p.id] || 0); // ë´‰ì‡„ ì¡°í•­ ì—†ìœ¼ë¯€ë¡œ 0ìœ¼ë¡œ ê°•ì œí•  í•„ìš” ì—†ìŒ
          
          row.innerHTML += `<td>${districtPercentage}<br><b>${allocatedSeats}</b></td>`;
        });

        if (winnerInDistrict) {
            row.innerHTML += `<td class="winner"><span class="dot" style="background:${winnerInDistrict.color}"></span>${winnerInDistrict.name}</td>`;
        } else {
            row.innerHTML += `<td class="winner">-</td>`;
        }
        table.appendChild(row);
      });

      districtResults.appendChild(table);

      const totalCalculatedSeats = Object.values(nationalSeats).reduce((sum, seats) => sum + seats, 0);
      console.log("ì‹œë®¬ë ˆì´í„°ì—ì„œ ê³„ì‚°ëœ ì´ ì˜ì„ìˆ˜ (ë´‰ì‡„ ì¡°í•­ ì—†ìŒ):", totalCalculatedSeats);

      const partiesWithSeats = Object.keys(nationalSeats).filter(id => nationalSeats[id] > 0);

      const sortedParties = partiesWithSeats.map(id => {
          const party = parties.find(p => p.id === id);
          const nationalPercentage = nationalPartyPercentages[id];
          return {
              party: party,
              seats: nationalSeats[id],
              percentage: nationalPercentage.toFixed(1) + '%'
          };
      }).sort((a, b) => b.seats - a.seats);

      sortedParties.forEach(({ party, seats, percentage }) => {
          const partyCard = document.createElement("div");
          partyCard.className = "projection-party-card";
          partyCard.style.backgroundColor = party.color;
          
          partyCard.innerHTML = `
              <div class="projection-party-name">${party.name}</div>
              <div class="projection-seats">${seats}</div>
              <div class="projection-percentage">${percentage}</div>
              <div class="projection-change"></div>
          `;
          seatProjectionGrid.appendChild(partyCard);
      });

      sortedParties.forEach(({ party, seats }) => {
          const segment = document.createElement('div');
          segment.className = 'seat-bar-segment';
          segment.style.backgroundColor = party.color;
          segment.style.width = `${(seats / totalCalculatedSeats) * 100}%`;
          seatBarContainer.appendChild(segment);
      });
      
      const select = document.querySelector('.constituency-select-container select');
      select.value = "";
      document.getElementById('constituencyDetail').innerHTML = "ìì„¸í•œ ë¶„ì„ì„ ë³´ë ¤ë©´ ì„ ê±°êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.";
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    renderPartyCards();
    populateConstituencyDropdown();
  </script>

</body>
</html>
